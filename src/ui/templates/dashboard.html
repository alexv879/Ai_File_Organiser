<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI File Organiser Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .file-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .file-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .license-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .license-valid {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .license-invalid {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            max-width: 400px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI File Organiser</h1>
            <p>Your private, local-first file organization assistant</p>
        </header>

        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be loaded dynamically -->
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('inbox')">üì• Inbox</button>
            <button class="tab" onclick="switchTab('history')">üìä History</button>
            <button class="tab" onclick="switchTab('duplicates')">üîç Duplicates</button>
            <button class="tab" onclick="switchTab('search')">üîé Search</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('license')">üîê License</button>
        </div>

        <div id="inbox" class="tab-content active">
            <h2>Pending Files</h2>
            <div id="pending-files">
                <!-- Files will be loaded dynamically -->
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>Recent Actions</h2>
            <div id="history-list">
                <!-- History will be loaded dynamically -->
            </div>
        </div>

        <div id="duplicates" class="tab-content">
            <h2>Duplicate Files</h2>
            <button class="btn-primary" onclick="scanDuplicates()">Scan for Duplicates</button>
            <div id="duplicates-list" style="margin-top: 20px;">
                <!-- Duplicates will be loaded dynamically -->
            </div>
        </div>

        <div id="search" class="tab-content">
            <h2>Find moved files</h2>
            <div style="margin-bottom: 12px; display:flex; gap:8px; align-items:center;">
                <input type="text" id="search-query" placeholder="Search by filename, folder, or text" style="flex:1;" />
                <input type="text" id="search-category" placeholder="Category (optional)" style="width:200px;" />
                <button class="btn-primary" onclick="searchFiles()">Search</button>
            </div>
            <div id="search-results">
                <!-- Search results will appear here -->
            </div>
        </div>

        <div id="settings" class="tab-content">
            <h2>Settings</h2>
            <div class="settings-container">
                <div class="setting-item">
                    <div>
                        <strong>Auto Mode</strong>
                        <p style="font-size: 14px; color: #666; margin-top: 5px;">Automatically organize files without approval</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-mode-toggle" onchange="updateSetting('auto_mode', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <strong>Dry Run Mode</strong>
                        <p style="font-size: 14px; color: #666; margin-top: 5px;">Simulate actions without actually moving files</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dry-run-toggle" checked onchange="updateSetting('dry_run', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <strong>AI Classification</strong>
                        <p style="font-size: 14px; color: #666; margin-top: 5px;">Use local AI for intelligent file classification</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="ai-toggle" checked onchange="updateSetting('enable_ai', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div id="license" class="tab-content">
            <h2>License Management</h2>
            <div id="license-status">
                <!-- License status will be loaded dynamically -->
            </div>
            <div style="margin-top: 20px;">
                <h3>Activate License</h3>
                <p style="color: #666; margin: 10px 0;">Enter your license key (format: XXXX-XXXX-XXXX-XXXX)</p>
                <input type="text" id="license-key-input" placeholder="ABCD-1234-EFGH-5678">
                <button class="btn-primary" onclick="activateLicense()" style="margin-left: 10px;">Activate</button>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'license') {
                loadLicenseStatus();
            } else if (tabName === 'inbox') {
                loadPendingFiles();
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card">
                        <h3>Files Organised</h3>
                        <div class="value">${stats.files_organised}</div>
                        <div class="label">Total files</div>
                    </div>
                    <div class="stat-card">
                        <h3>Time Saved</h3>
                        <div class="value">${stats.time_saved_hours}</div>
                        <div class="label">Hours</div>
                    </div>
                    <div class="stat-card">
                        <h3>AI Classifications</h3>
                        <div class="value">${stats.ai_classifications}</div>
                        <div class="label">Using AI</div>
                    </div>
                    <div class="stat-card">
                        <h3>Duplicates Removed</h3>
                        <div class="value">${stats.duplicates_removed}</div>
                        <div class="label">Files</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load pending files
        async function loadPendingFiles() {
            try {
                const response = await fetch('/api/pending-files');
                const files = await response.json();

                const container = document.getElementById('pending-files');

                if (files.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No pending files</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = files.map(file => `
                    <div class="file-item">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-meta">
                            Category: ${file.classification.category} |
                            Suggested: ${file.classification.suggested_path || 'N/A'}
                        </div>
                        <div class="file-meta" style="font-size: 12px; font-style: italic;">
                            ${file.classification.reason}
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="approveFile('${file.file_path}')">‚úì Approve</button>
                            <button class="btn-secondary" onclick="rejectFile('${file.file_path}')">‚úó Reject</button>
                            <button class="btn-secondary" onclick="deepAnalyze('${file.file_path}')">üîç Deep Analyze</button>
                        </div>
                        <div id="deep-analysis-${btoa(file.file_path).replace(/=/g,'')}" style="display:none; margin-top:15px; padding:15px; background:#f9f9f9; border-radius:6px;"></div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading pending files:', error);
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const history = await response.json();

                const container = document.getElementById('history-list');

                if (history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No history yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = history.map(item => `
                    <div class="file-item">
                        <div class="file-name">${item.filename}</div>
                        <div class="file-meta">
                            ${item.operation} | ${new Date(item.timestamp).toLocaleString()}
                        </div>
                        <div class="file-meta" style="font-size: 12px;">
                            ${item.old_path} ‚Üí ${item.new_path || 'Deleted'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Load license status
        async function loadLicenseStatus() {
            try {
                const response = await fetch('/api/license/status');
                const status = await response.json();

                const container = document.getElementById('license-status');
                const isValid = status.is_valid;

                container.innerHTML = `
                    <div class="license-status ${isValid ? 'license-valid' : 'license-invalid'}">
                        <strong>Status:</strong> ${status.status.toUpperCase()}<br>
                        ${status.message}
                        ${status.days_remaining ? `<br><strong>${status.days_remaining}</strong> days remaining` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading license status:', error);
            }
        }

        // Approve file action
        async function approveFile(filePath) {
            try {
                const response = await fetch('/api/files/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath })
                });

                const result = await response.json();
                alert(result.message);
                loadPendingFiles();
                loadStats();
            } catch (error) {
                console.error('Error approving file:', error);
            }
        }

        // Reject file action
        async function rejectFile(filePath) {
            try {
                const response = await fetch('/api/files/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath })
                });

                const result = await response.json();
                loadPendingFiles();
            } catch (error) {
                console.error('Error rejecting file:', error);
            }
        }

        // Activate license
        async function activateLicense() {
            const key = document.getElementById('license-key-input').value;

            if (!key) {
                alert('Please enter a license key');
                return;
            }

            try {
                const response = await fetch('/api/license/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: key })
                });

                const result = await response.json();
                alert(result.message);
                loadLicenseStatus();
            } catch (error) {
                console.error('Error activating license:', error);
            }
        }

        // Update settings
        async function updateSetting(setting, value) {
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [setting]: value })
                });

                const result = await response.json();
                console.log('Setting updated:', result);
            } catch (error) {
                console.error('Error updating setting:', error);
            }
        }

        // Scan for duplicates
        async function scanDuplicates() {
            const container = document.getElementById('duplicates-list');
            container.innerHTML = '<p>Scanning for duplicates...</p>';

            try {
                const response = await fetch('/api/duplicates/scan');
                const duplicates = await response.json();

                if (duplicates.groups.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No duplicates found!</p>
                        </div>
                    `;
                    return;
                }

                const prot = duplicates.protected || { protected_groups: 0, protected_files: 0 };
                const protSummary = prot.protected_groups > 0 || prot.protected_files > 0;

                const safetyPanel = protSummary ? `
                    <div style="margin: 12px 0; padding: 12px; border-left: 4px solid #4caf50; background:#f4fbf4; border-radius:6px;">
                        <strong>üõ°Ô∏è Protection Report</strong><br/>
                        Protected duplicate groups: <strong>${prot.protected_groups}</strong><br/>
                        Protected files: <strong>${prot.protected_files}</strong><br/>
                        <div style="font-size:12px;color:#666;margin-top:6px;">Application and game files were automatically skipped to prevent breaking software.</div>
                    </div>
                ` : '';

                container.innerHTML = `
                    <p><strong>Found ${duplicates.summary.total_duplicate_groups} duplicate groups</strong></p>
                    <p>Total wasted space: ${duplicates.summary.total_wasted_space_mb} MB</p>
                    ${safetyPanel}
                    <div style="margin-top: 20px;">
                        ${duplicates.groups.slice(0, 10).map((group, idx) => `
                            <div class="file-item">
                                <div class="file-name">Duplicate Group ${idx + 1}</div>
                                <div class="file-meta">${group.count} files, ${group.size} bytes each</div>
                                ${group.paths.map(path => `<div style="font-size: 12px; color: #666;">${path}</div>`).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error scanning duplicates:', error);
                container.innerHTML = '<p style="color: red;">Error scanning for duplicates</p>';
            }
        }

        // Search files
        async function searchFiles() {
            const q = document.getElementById('search-query').value;
            const category = document.getElementById('search-category').value;
            const params = new URLSearchParams();
            if (q) params.append('q', q);
            if (category) params.append('category', category);

            const container = document.getElementById('search-results');
            container.innerHTML = '<p>Searching...</p>';

            try {
                const response = await fetch('/api/search?' + params.toString());
                const results = await response.json();

                if (!results || results.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No results</p></div>';
                    return;
                }

                container.innerHTML = results.map(item => `
                    <div class="file-item">
                        <div class="file-name">${item.filename}</div>
                        <div class="file-meta">${item.operation} | ${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="file-meta" style="font-size:12px;">${item.old_path} ‚Üí ${item.new_path || 'Deleted'}</div>
                        <div class="file-meta" style="font-size:12px; font-style:italic;">Category: ${item.category || 'N/A'}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error searching files:', error);
                container.innerHTML = '<p style="color: red;">Error searching files</p>';
            }
        }

        // Deep analyze file
        async function deepAnalyze(filePath) {
            const containerId = 'deep-analysis-' + btoa(filePath).replace(/=/g, '');
            const container = document.getElementById(containerId);

            // Show container and display loading state
            container.style.display = 'block';
            container.innerHTML = '<p style="color: #667eea;">ü§ñ Running deep agent analysis...</p>';

            try {
                const response = await fetch('/api/files/deep-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath })
                });

                const result = await response.json();

                // Format the analysis result
                const evidence = result.evidence || [];
                const evidenceHtml = evidence.length > 0
                    ? `<div style="margin-top: 10px;">
                         <strong>Evidence:</strong>
                         <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                           ${evidence.map(e => `<li>${e}</li>`).join('')}
                         </ul>
                       </div>`
                    : '';

                const blockReason = result.block_reason
                    ? `<div style="margin-top: 10px; color: #f44336;"><strong>‚ö†Ô∏è Blocked:</strong> ${result.block_reason}</div>`
                    : '';

                container.innerHTML = `
                    <div style="border-left: 3px solid #667eea; padding-left: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #667eea;">üß† Agent Analysis Result</h4>
                        <div><strong>Category:</strong> ${result.category || 'N/A'}</div>
                        <div><strong>Suggested Path:</strong> ${result.suggested_path || 'N/A'}</div>
                        <div><strong>Rename:</strong> ${result.rename || 'No rename suggested'}</div>
                        <div><strong>Confidence:</strong> <span style="text-transform: uppercase; font-weight: bold; color: ${
                            result.confidence === 'high' ? '#4caf50' :
                            result.confidence === 'medium' ? '#ff9800' : '#f44336'
                        }">${result.confidence || 'N/A'}</span></div>
                        <div><strong>Suggested Action:</strong> ${result.action || 'none'}</div>
                        <div style="margin-top: 8px;"><strong>Reason:</strong> ${result.reason || 'N/A'}</div>
                        ${evidenceHtml}
                        ${blockReason}
                    </div>
                    <button class="btn-secondary" onclick="document.getElementById('${containerId}').style.display='none'" style="margin-top: 10px;">
                        Close
                    </button>
                `;

            } catch (error) {
                console.error('Error during deep analysis:', error);
                container.innerHTML = `
                    <p style="color: red;">‚ùå Deep analysis failed: ${error.message}</p>
                    <button class="btn-secondary" onclick="document.getElementById('${containerId}').style.display='none'" style="margin-top: 10px;">
                        Close
                    </button>
                `;
            }
        }

        // Initial load
        loadStats();
        loadPendingFiles();
        setInterval(loadStats, 30000); // Refresh stats every 30 seconds
        setInterval(loadPendingFiles, 10000); // Refresh pending files every 10 seconds
    </script>
</body>
</html>